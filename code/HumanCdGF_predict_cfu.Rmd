---
title: "humanCdGF_predict_cfu"
author: "Nicholas Lesniak"
date: "October 7, 2016"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, fig.width=7, fig.height=8)
```

```{r setup environment}
pack_used <- c('randomForest','tidyr','ggplot2','plyr', 'dplyr', 'caret')
for (dep in pack_used){
  if (dep %in% installed.packages()[,"Package"] == FALSE){
    install.packages(as.character(dep), repos = 'http://cran.us.r-project.org', 
                     quiet=TRUE);
  }
  library(dep, verbose=FALSE, character.only=TRUE)
}
```

```{r setup data}
# read in files
setwd('~/Documents/Github/Schubert_humanCdGF_XXXX_2016/')
meta_data   <- 'data/process/human_CdGF_metadata.txt'
shared_file <- 'data/process/human_CdGF.an.unique_list.0.03.subsample.shared'
tax_file <- 'data/process/gf_new.an.taxonomy'
tax_function <- '~/Documents/Github/Schubert_humanCdGF_XXXX_2016/code/tax_level.R'

# read in files
meta_data   <- read.table(meta_data, sep = '\t', header = T, stringsAsFactors = F)
shared_file <- read.table(shared_file, sep = '\t', header = T, row.names = 'sample_id')
tax_file <- read.table(tax_file, sep = '\t', header = T, row.names = 'OTU')
source(tax_function)

# set parameters
seed <- 1
n_trees <- 1001
n_otus <- 12
iters <- 100
cor_cutoff <- 0.75

# remove samples not used or with other cdiff strains
meta_data <- 
  meta_data %>% 
  filter(Early_Euth == FALSE, cdiff_strain == 431, !cage_id == 'NP1') %>% 
  select(mouse_id, sample_id, cage_id, day, log_cfu) %>% 
  filter(!is.na(log_cfu))
shared_list_days <- meta_data %>% 
  filter(day == 0) %>% 
  select(-day, -log_cfu, -cage_id)
shared_file <- shared_file[rownames(shared_file) %in% shared_list_days$sample_id, ]

# create shared with relative abundances over 1%
mean_otu_counts <- unique(apply(shared_file, 1, sum))
rel_abund_shared <- shared_file
rel_abund_shared_01 <- rel_abund_shared[ , apply(rel_abund_shared, 2, max) > 1]
# remove correlative otus
rel_abund_cor <- cor(rel_abund_shared_01, method = 'spearman')
rownames(rel_abund_cor) <- colnames(rel_abund_shared_01) # add row names to identify otus correlated with features
cor_otus <- findCorrelation(rel_abund_cor, cutoff = cor_cutoff)
rel_abund_01_filtr <- rel_abund_shared_01[,-cor_otus]
community_d0.df <- merge(shared_list_days, rel_abund_01_filtr, 
                         by.x = 'sample_id', by.y = 'row.names') %>% 
                    select(-sample_id)
```

### Reframing the question for predicting CFU
#### 1. Can Day 0 community predict the median steady-state-colonized CFU?

```{r predict median CFU, fig.width=10,fig.height=10}
colonized_cfu <- meta_data %>% 
  filter(day %in% c(4:10)) %>% 
  group_by(mouse_id, cage_id) %>% 
  summarise(log_cfu_med = median(log_cfu)) %>% 
  ungroup()

cfu_shared_colonized.df <- colonized_cfu %>% 
    right_join(community_d0.df) %>% 
    select(-mouse_id, -cage_id) %>% 
    filter(!is.na(log_cfu_med))

##### feature reduction #####
###### select top n otus reiteratively and select otus that appear > 50% of iterations
rfRFE <-  list(summary = defaultSummary,
               fit = function(x, y, first, last, ...){
                 library(randomForest)
                 randomForest(x, y, importance = first, keep.forest = T, ntree = n_trees, ...)
                 },
               pred = function(object, x)  predict(object, x),
               rank = function(object, x, y) {
                 vimp <- varImp(object)
                 vimp <- vimp[order(vimp$Overall,decreasing = TRUE),,drop = FALSE]
                 vimp$var <- rownames(vimp)                  
                 vimp
                 },
               selectSize = pickSizeTolerance,
               selectVar = pickVars)

rfe_ctrl <- rfeControl(functions = rfRFE,
                   method = "repeatedcv",
                   repeats = 10,
                   verbose = FALSE)
subsets <- c(1:20, c(seq(25, 85, 10)))
set.seed(seed)
rf_cfu_model <- rfe(cfu_shared_colonized.df[ , -1], cfu_shared_colonized.df$log_cfu_med,
                 sizes = subsets,
                 rfeControl = rfe_ctrl)
top_important_OTU <- predictors(rf_cfu_model)

rf_n_features <- rf_cfu_model$fit
rf_prediction <- data.frame(observed = cfu_shared_colonized.df$log_cfu_med, 
                       predicted = rf_n_features$predicted)
rf_prediction <- merge(rf_prediction, colonized_cfu, by.x = 'observed', by.y = 'log_cfu_med')

##### - leave one cage out cv
LOcO_df <- data.frame(colonized_cfu %>% 
    right_join(community_d0.df) %>% 
    filter(!is.na(log_cfu_med)) %>% 
    select(log_cfu_med, mouse_id, cage_id, one_of(top_important_OTU)))
cage_list <- unique(LOcO_df$cage_id)

LOcO_probs <- c()
rsq <- c()
import_otus <- data.frame(otu = top_important_OTU)
for(i in 1:length(cage_list)){
  by_cage <- LOcO_df$cage_id == cage_list[i]
  LOcO_predict <- select(LOcO_df, -cage_id, -mouse_id)
  train <- LOcO_predict[!by_cage,]
  test <- LOcO_predict[by_cage,]
  set.seed(seed)
  temp_model <- randomForest(log_cfu_med~., data=train, pdel=0.99, ntree=500, importance=T)
  import_df <- importance(temp_model)
  colnames(import_df)[1] <- cage_list[i]
  import_otus <- merge(import_otus, import_df, by.x = 'otu', by.y = 'row.names')
  import_otus <- select(import_otus, -IncNodePurity)
  rsq[i] <- round(tail(temp_model$rsq, 1), 2)
  LOcO_probs <- rbind(LOcO_probs, data.frame(observed=test$log_cfu_med, 
                                             predicted=predict(temp_model, test),
                                             mouse_id=LOcO_df$mouse_id[by_cage],
                                             cage_id=rep(cage_list[i], nrow(test))))
}
med_otu_importance <- data.frame(otu = import_otus$otu,
                                 importance = apply(import_otus[, -1], 1, median))
med_otu_importance <- med_otu_importance[order(med_otu_importance$importance, decreasing = T),]

LOcO_rsq <- 1 - (sum((LOcO_probs$observed - LOcO_probs$predicted)^2)/
                   sum((LOcO_probs$observed - mean(LOcO_probs$observed))^2))

#One per cage
one_mouse_df <- data.frame(colonized_cfu %>% 
    right_join(community_d0.df) %>% 
    filter(!is.na(log_cfu_med))  %>% 
    select(log_cfu_med, mouse_id, cage_id, one_of(top_important_OTU)))

om_import_otus <- data.frame(otu = colnames(select(one_mouse_df, contains('Otu'))))
om_pred <- c()
for(i in 1:iters){
    set.seed(i)
    train <- one_mouse_df %>% 
      group_by(cage_id) %>% 
      sample_n(1) %>% ungroup() 
    test <- one_mouse_df %>% 
      filter(!mouse_id %in% train$mouse_id)
    set.seed(seed)
    rf_om <- randomForest(log_cfu_med ~ ., data = select(train, -mouse_id, -cage_id),
                             importance = TRUE, keep.forest = T, ntree = n_trees)
    om_pred <- rbind(om_pred,
                     data.frame(select(test, mouse_id, cage_id, log_cfu_med),
                          predicted=predict(rf_om, test)))
    import_df <- importance(rf_om)
    colnames(import_df)[1] <- paste(train$mouse_id, collapse = ' ')
    om_import_otus <- merge(om_import_otus, import_df, by.x = 'otu', by.y = 'row.names')
    om_import_otus <- select(om_import_otus, -IncNodePurity)
}
om_rsq <- 1 - (sum((om_pred$log_cfu_med - om_pred$predicted)^2)/
               sum((om_pred$log_cfu_med - mean(om_pred$log_cfu_med))^2))

om_pred <- rename(om_pred, observed = log_cfu_med)

om_import_otus <- data.frame(om_import_otus[ , -1], row.names = om_import_otus$otu)
colnames(om_import_otus) <- seq(ncol(om_import_otus))
om_otu_rank <- apply(om_import_otus, 2, function(x) rank(x, na.last = F))
om_raw_rank <- sort(apply(om_otu_rank, 1, function(x) sum(x, na.rm = T)), decreasing = T)
med_otu_importance_om <- data.frame(otu = names(om_raw_rank),
                                 importance = om_raw_rank)

# one mouse leave one out
om_loo_pred <- c()
for(i in 1:iters){
    set.seed(i)
    one_mouse <- one_mouse_df %>% 
      group_by(cage_id) %>% 
      sample_n(1) %>% ungroup() 
    for (n in unique(as.character(one_mouse$cage_id))){
      train <- filter(one_mouse, !cage_id == n)
      test <- one_mouse_df %>% 
        filter(cage_id == n)
      set.seed(seed)
      rf_om_loo <- randomForest(log_cfu_med ~ ., data = select(train, -mouse_id, -cage_id),
                                ntree = 500)
      om_loo_pred <- rbind(om_loo_pred,
                           data.frame(select(test, mouse_id, cage_id, log_cfu_med),
                           predicted=predict(rf_om_loo, test)))
    }
}

om_loo_rsq <- 1 - (sum((om_loo_pred$log_cfu_med - om_loo_pred$predicted)^2)/
               sum((om_loo_pred$log_cfu_med - mean(om_loo_pred$log_cfu_med))^2))
om_loo_pred <- rename(om_loo_pred, observed = log_cfu_med)

#### merge OOB and leave 1 cage out dataframes
all_rf <- rbind(cbind(rf_prediction, data = rep('OOB', nrow(rf_prediction))),
                cbind(LOcO_probs, data = rep('LOO', nrow(LOcO_probs))),
                cbind(om_loo_pred, data = rep('om_loo', nrow(LOcO_probs))),
                cbind(om_pred, data = rep('1_mouse', nrow(om_pred))))

ggplot(data = all_rf, aes(x=observed, y=predicted, color = data)) + 
  #geom_abline(color = 'gray', size = 0.5, linetype = 2, slope = 1) + 
  # geom_point() + 
  #geom_smooth(method = 'lm', se = F) +
  stat_summary(fun.y=median, geom="point", aes(group = data)) + 
  stat_summary(fun.data = 'median_hilow') +
  xlim(c(5,9)) + ylim(c(5,9)) +
  labs(x= 'Observed Log10 CFU', y = 'Predicted Log10 CFU',
       title = "Random Forest Prediction of Colonized C Difficile CFU from Day 0 Community") + 
  theme_bw() + 
  scale_color_discrete(name = NULL,
                       breaks = c('OOB', 'LOO', '1_mouse', 'om_loo'),
                       labels = c(bquote('OOB (R'^'2'*' = '*.(round(tail(rf_n_features$rsq, 1), 2))*')'),
                                  bquote('LOO (R'^'2'*' = '*.(round(LOcO_rsq, 2))*')'),
                                  bquote('OM (R'^'2'*' = '*.(round(om_rsq,2))*')'),
                                  bquote('OM-LOO (R'^'2'*' = '*.(round(om_loo_rsq,2))*')'))) + 
  theme(legend.justification=c(0,1), legend.position=c(0,1))

importance_om <- get_tax(1, med_otu_importance_om$otu, tax_file)
features_cor <- sapply(as.character(med_otu_importance_om$otu), 
                       function(i)rownames(rel_abund_cor)[rel_abund_cor[,i] > cor_cutoff])

partial_df <- data.frame(colonized_cfu %>% 
    right_join(community_d0.df) %>% 
    select(mouse_id, cage_id, log_cfu_med, one_of(rownames(importance_om))) %>% 
    filter(!is.na(log_cfu_med)))

color <- sapply(1:length(unique(partial_df$cage_id)), 
                           function(n){
                             set.seed(n+10) # add modify to generate distinct colors
                             rgb(sample(c(0:255), 1),sample(c(0:255), 1),
                                 sample(c(0:255), 1), maxColorValue = 255)
                             })

layout(matrix(c(1:9), ncol=3, byrow=TRUE))
for(otu in seq_along(importance_om$tax)){
    partialPlot(rf_n_features, data.frame(cfu_shared_colonized.df), x.var=rownames(importance_om)[otu],
                xlab='', main = NULL)
    if(length(features_cor[[otu]]) > 1){
      title(main = paste0('Unidentifiable Feature\n(', 
                          get_tax(row_list = rownames(importance_om)[otu])$tax_label,
                          ' Shown)'))
      mtext(side = 1, line = 3, cex = 0.6,
        paste('Correlated features: \n', 
              paste(get_tax(row_list = features_cor[[otu]])$tax_label, collapse = ', ')))
      } else {
      title(paste(get_tax(row_list = rownames(importance_om)[otu])$tax_label))
        }
    par(new = T)
    plot(y = partial_df[ , 'log_cfu_med'],
         x = partial_df[ , rownames(importance_om)[otu]], 
         pch = NA, bg = 'gray', xlab = NA, ylab = NA, axes = F)
    axis(side = 4)
    mtext(side = 4, line = 3, 'Log10 CFU')
# To color points by mouse - Change pch to 21 and un-comment following lines
  lapply(seq_along(unique(partial_df$cage_id)), function(m){
    mouse <- unique(partial_df$cage_id)[m]
    points(y = partial_df[partial_df$cage_id %in% mouse, 'log_cfu_med'],
           x = partial_df[partial_df$cage_id %in% mouse , rownames(importance_om)[otu]], 
           pch = 21, cex = 2, bg = color[m], xlab = NA, ylab = NA, axes = F)
  })
}
```



#### 2. Can Day 0 community predict the rate of colonization?

```{r predict colonization rate, fig.width=10,fig.height=10}

mouse_list <- meta_data %>% 
  select(mouse_id) %>% 
  unique() %>% 
  filter(!mouse_id == 'NP2_983') # remove NP2_983 no colonization data

mouse_list <- as.character(mouse_list$mouse_id)

col_rate <- sapply(mouse_list, function(i){
  test <- meta_data %>% 
    filter(!is.na(day), mouse_id == i) %>% 
    select(day, log_cfu) %>% 
    filter(!is.na(log_cfu))
  test$rel_cr <- test$log_cfu/median(test$log_cfu[test$day %in% c(4:10)])
  colonization_ratio <- sum(test$rel_cr[test$day %in% c(1:4)])/sum(test$day %in% c(1:4))})
col_rate <- meta_data %>% 
  select(mouse_id, cage_id) %>% 
  unique() %>% 
  right_join(data.frame(mouse_id = names(col_rate), ratio = col_rate, 
                       stringsAsFactors = F, row.names = NULL))

shared_col_rate_df <- col_rate %>% 
    inner_join(community_d0.df)
shared_cr_df <- select(shared_col_rate_df, -mouse_id, -cage_id)

set.seed(seed)
rf_cr_model <- rfe(shared_cr_df[ , -1], shared_cr_df$ratio,
                 sizes = subsets,
                 rfeControl = rfe_ctrl)
cr_features <- predictors(rf_cr_model)
rf_col_rate <- rf_cr_model$fit

cr_prediction <- data.frame(observed = shared_cr_df$ratio, 
                       predicted = rf_col_rate$predicted)
cr_prediction <- merge(cr_prediction, col_rate, by.x = 'observed', by.y = 'ratio')

##### - leave one cage out cv
LOcO_cr_df <- data.frame(shared_col_rate_df %>% 
    select(ratio, mouse_id, cage_id, one_of(cr_features)))
cage_list <- unique(LOcO_cr_df$cage_id)

LOcO_cr_probs <- c()
rsq_cr <- c()
import_otus_cr <- data.frame(otu = cr_features)
for(i in 1:length(cage_list)){
  by_cage <- LOcO_cr_df$cage_id == cage_list[i]
  LOcO_predict_cr <- select(LOcO_cr_df, -cage_id, -mouse_id)
  train <- LOcO_predict_cr[!by_cage,]
  test <- LOcO_predict_cr[by_cage,]
  set.seed(seed)
  temp_model <- randomForest(ratio~., data=train, pdel=0.99, ntree=500, importance=T)
  import_df <- importance(temp_model)
  colnames(import_df)[1] <- cage_list[i]
  import_otus_cr <- merge(import_otus_cr, import_df, by.x = 'otu', by.y = 'row.names')
  import_otus_cr <- select(import_otus_cr, -IncNodePurity)
  rsq_cr[i] <- round(tail(temp_model$rsq, 1), 2)
  LOcO_cr_probs <- rbind(LOcO_cr_probs, data.frame(observed=test$ratio, 
                                             predicted=predict(temp_model, test),
                                             mouse_id=LOcO_cr_df$mouse_id[by_cage],
                                             cage_id=rep(cage_list[i], nrow(test))))
}
med_otu_importance_cr <- data.frame(otu = import_otus_cr$otu,
                                 importance = apply(import_otus_cr[, -1], 1, median))
med_otu_importance_cr <- med_otu_importance_cr[order(med_otu_importance_cr$importance, decreasing = T),]

LOcO_rsq_cr <- 1 - (sum((LOcO_cr_probs$observed - LOcO_cr_probs$predicted)^2)/
                   sum((LOcO_cr_probs$observed - mean(LOcO_cr_probs$observed))^2))

#One per cage
om_cr_df <- LOcO_cr_df

om_import_otus_cr <- data.frame(otu = colnames(select(om_cr_df, contains('Otu'))))
om_pred_cr <- c()
for(i in 1:iters){
    set.seed(i)
    train <- om_cr_df %>% 
      group_by(cage_id) %>% 
      sample_n(1) %>% ungroup() 
    test <- om_cr_df %>% 
      filter(!mouse_id %in% train$mouse_id)
    set.seed(seed)
    rf_om <- randomForest(ratio ~ ., data = select(train, -mouse_id, -cage_id),
                             importance = TRUE, keep.forest = T, ntree = n_trees)
    om_pred_cr <- rbind(om_pred_cr,
                     data.frame(select(test, mouse_id, cage_id, ratio),
                          predicted=predict(rf_om, test)))
    import_df <- importance(rf_om)
    colnames(import_df)[1] <- paste(train$mouse_id, collapse = ' ')
    om_import_otus_cr <- merge(om_import_otus_cr, import_df, by.x = 'otu', by.y = 'row.names')
    om_import_otus_cr <- select(om_import_otus_cr, -IncNodePurity)
}
om_rsq_cr <- 1 - (sum((om_pred_cr$ratio - om_pred_cr$predicted)^2)/
                  sum((om_pred_cr$ratio - mean(om_pred_cr$ratio))^2))

om_pred_cr <- rename(om_pred_cr, observed = ratio)

om_import_otus_cr <- data.frame(om_import_otus_cr[ , -1], row.names = om_import_otus_cr$otu)
om_otu_rank_cr <- apply(om_import_otus_cr, 2, function(x) rank(x, na.last = F))
om_raw_rank_cr <- sort(apply(om_otu_rank_cr, 1, function(x) sum(x, na.rm = T)), decreasing = T)
med_otu_importance_om <- data.frame(otu = names(om_raw_rank_cr),
                                 importance = om_raw_rank_cr)

# one mouse leave one out
om_loo_pred_cr <- c()
for(i in 1:iters){
    set.seed(i)
    one_mouse <- om_cr_df %>% 
      group_by(cage_id) %>% 
      sample_n(1) %>% ungroup() 
    for (n in unique(as.character(one_mouse$cage_id))){
      train <- filter(one_mouse, !cage_id == n)
      test <- om_cr_df %>% 
        filter(cage_id == n)
      set.seed(seed)
      rf_om_loo_cr <- randomForest(ratio ~ ., data = select(train, -mouse_id, -cage_id),
                                ntree = 500)
      om_loo_pred_cr <- rbind(om_loo_pred_cr,
                           data.frame(select(test, mouse_id, cage_id, ratio),
                           predicted=predict(rf_om_loo_cr, test)))
    }
}

om_loo_rsq_cr <- 1 - (sum((om_loo_pred_cr$ratio - om_loo_pred_cr$predicted)^2)/
               sum((om_loo_pred_cr$ratio - mean(om_loo_pred_cr$ratio))^2))
om_loo_pred_cr <- rename(om_loo_pred_cr, observed = ratio)



#### merge OOB and leave 1 cage out dataframes
all_cr_rf <- rbind(cbind(cr_prediction, data = rep('OOB', nrow(cr_prediction))),
                cbind(LOcO_cr_probs, data = rep('LOO', nrow(LOcO_cr_probs))),
                cbind(om_loo_pred_cr, data = rep('OM_LOO', nrow(om_loo_pred_cr))),
                cbind(om_pred_cr, data = rep('1_mouse', nrow(om_pred_cr))))

ggplot(data = all_cr_rf, aes(x=observed, y=predicted, color = data)) + 
  #geom_abline(color = 'gray', size = 0.5, linetype = 2, slope = 1) + 
  # geom_point() + 
  #geom_smooth(method = 'lm', se = F) +
  stat_summary(fun.y=median, geom="point", aes(group = data)) + 
  stat_summary(fun.data = 'median_hilow') +
  xlim(c(min(all_cr_rf[, c('observed','predicted')]),
         max(all_cr_rf[, c('observed','predicted')]))) + 
  ylim(c(min(all_cr_rf[, c('observed','predicted')]),
         max(all_cr_rf[, c('observed','predicted')]))) +
  labs(x= 'Observed Log10 CFU', y = 'Predicted Log10 CFU',
       title = "Random Forest Prediction of C. Difficile Colonization Rate from Day 0 Community") + 
  theme_bw() + 
  scale_color_discrete(name = NULL,
                       breaks = c('OOB', 'LOO', '1_mouse', 'OM_LOO'),
                       labels = c(bquote('OOB (R'^'2'*' = '*.(round(tail(rf_col_rate$rsq, 1), 2))*')'),
                                  bquote('LOO (R'^'2'*' = '*.(round(LOcO_rsq_cr, 2))*')'),
                                  bquote('OM (R'^'2'*' = '*.(round(om_rsq_cr,2))*')'),
                                  bquote('OM_LOO (R'^'2'*' = '*.(round(om_loo_rsq_cr,2))*')'))) + 
  theme(legend.justification=c(0,1), legend.position=c(0,1))

cr_features_cor <- sapply(as.character(cr_features), 
                       function(i)rownames(rel_abund_cor)[rel_abund_cor[,i] > cor_cutoff])

layout(matrix(c(1:9), ncol=3, byrow=TRUE))

cage_color <- rainbow(length(unique(cr_prediction$cage_id)))
for (otu in seq_along(cr_features)) {
    partialPlot(rf_col_rate, shared_cr_df, cr_features[otu],
                xlab='', main = NULL)
    if(length(cr_features_cor[[otu]]) > 1){
      title(main = paste0('Unidentifiable Feature\n(', 
                          get_tax(row_list = cr_features[otu])$tax_label,
                          ' Shown)'))
      mtext(side = 1, line = 3, cex = 0.6,
        paste('Correlated features: \n', 
              paste(get_tax(row_list = cr_features_cor[[otu]])$tax_label, collapse = ', ')))
      } else {
      title(paste(get_tax(row_list = cr_features[otu])$tax_label))
        }
  par(new = T)
    plot(y = shared_col_rate_df[ , 'ratio'],
         x = shared_col_rate_df[ , cr_features[otu]], 
         pch = NA, bg = 'gray', xlab = NA, ylab = NA, axes = F)
    axis(side = 4)
    mtext(side = 4, line = 3, 'Relative Colonization')
# To color points by mouse - Change pch to 21 and un-comment following lines
  lapply(seq_along(unique(shared_col_rate_df$cage_id)), function(m){
    mouse <- unique(shared_col_rate_df$cage_id)[m]
    points(y = shared_col_rate_df[shared_col_rate_df$cage_id %in% mouse, 'ratio'],
           x = shared_col_rate_df[shared_col_rate_df$cage_id %in% mouse , cr_features[otu]], 
           pch = 21, cex = 2, bg = color[m], xlab = NA, ylab = NA, axes = F)
  })
}
```

Does not predict colonization rate as well  
  - could be due to removed (cage/inocula-sensitive) otus  
  - improper measurement of colonization rate  
  - colonization rate not microbiome dependent, may be dependent on host factors of acute infection

***  
  
***  